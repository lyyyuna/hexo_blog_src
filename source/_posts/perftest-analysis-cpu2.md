title: Linux 性能分析 - 上下文切换
date: 2020-06-18 16:30:38
categories:
- 测试
tags:
- Linux 性能分析
series: Linux 性能分析
---

## 前言

上一篇文章中提到，处于可运行状态的进程越多，平均负载也越高。

有人可能会有疑问，这种计算方法合理吗？同样是 100% 的 CPU 使用率，有 3 个可运行进程的系统的平均负载，是有 1 个可运行进程系统的负载的 3 倍？本文就试图从 CPU 上下文切换的角度来解释这一指标的合理性。

## 上下文切换定义

### CPU 上下文切换

虽然系统的 CPU 个数有限，但能支持同时运行个任务。当然这种同时只是宏观上的假象，如果从微观角度观察，会发现系统在不停轮流切换任务，使得每个任务都能获得运行的机会。

CPU 是状态 + 存储的模型，其符合图灵机这种理想设备：
1. 内存
2. PC 指针指向下一条待运行的指令（状态）
3. 计算规则
4. 其他辅助计算的寄存器（状态）

多任务的每个任务都有自己的状态。当任务 1 切出，任务 2 切入时，CPU 的状态也要切换成任务 2 上一次切出时的状态，这样任务 2 才能继续运行。这些状态即是 CPU 上下文，CPU 上下文切换即保存和恢复 PC 和辅助计算的寄存器。


### 进诚上下文切换

学过微机原理的同学就有疑问，这些寄存器似乎一只手就数的过来，切换的成本非常小，为什么会造成系统负载显著升高呢？Linux 操作系统中的任务有进诚和线程。切换的主要成本来自于进程/线程的上下文切换。

第一点，很多现代处理器都有很多种运行等级。比如在 x86 的保护模式，有四种特权等级。Linux 使用 Ring 0 和 Ring 3：

![x86 保护模式下特权等级](/img/posts/perf-cpu/450px-Priv_rings.svg.png)

1. Ring 0 是内核空间，具有最高权限，可访问所有硬件资源
2. Ring 3 是用户空间，权限最低，无法直接访问硬件资源

用户态权限有限，无法直接操作所有寄存器，所以进程的切换只能由内核态来管理和调度，必然发生用户态 <-> 内核态的频烦转换。而每个特权等级运行的代码不同，所以在切换用户态 <-> 内核态时，内核/用户空间本身的 CPU 上下文也需要互相切换。

第二点，进程本身的数据结构庞大。Linux 中使用数据结构 task_struct 来描述进程所有的资源，其主要成员有进程状态、内核栈信息、进程使用状态、PID、优先级、锁、时间片、队列、信号量、内存管理信息、文件列表等等与进程管理、调度密切相关的信息。当切换进程运行，这些数据结构也需要保存。

第三点，虚拟内存。内核为每个进程提供了一个假象，进程都是独占地在使用内存，这种独占是无法感知也无法使用。

虚拟内存和实际的物理内存之间映射不是一个地址一个地址的映射，而通过页表机制来实现。一页通常是 4096KB，这样的映射关系即为页表数据，为了减少页表数据，会采用多级页表，比如 Linux 为了让进程支持 256T 内存，采用了四级页表。页表机制会带来额外的问题，页表本身也是存在内存里的，四级页表最坏情况下需要 5 次内存 IO 才能获取一个真正的内存数据。

为了让操作系统更快地操作虚拟内存，处理器专门提供了 TLB(Translation Lookaside Buffer) 来管理虚拟内存到物理内存的映射关系。它可以理解为一个专用缓存，特点就是快，但缺点是存储的数据少，缓存有可能不命中。当系统发生进程切换，从进程 A 切换到进程 B，TLB 也必须刷新，那在刷新后，进程 B 必然会出现 TLB 不命中的情况，导致虚拟内存访问变慢。

由以上三点可见，进程上下文切换开销巨大，根据 [Tsuna](https://blog.tsunanet.net/2010/11/how-long-does-it-take-to-make-context.html)的测试报告，这一过程会持续数千纳秒。如果进程切换频繁，系统真正运行进程的时间便不够了。

### 线程上下文切换

在 Linux 的实现中，系统调度的基本单位其实是线程，进程是线程的集合，同一个进程的线程看到的虚拟内存是共享的，所以：

1. 如果切换的两个线程分属不同的进程，因为资源不共享，其切换成本等同于进程上下文切换。
2. 如果切换的两个线程属于同一个进程，因为虚拟内存是共享的，刷新 TLB 没有必要，切换成本也就少一些。

### 中断上下文切换

为了快速响应硬件事件，Linux 中发生中断也会打断进程的正常执行，这时候就会发生中断上下文切换。

中断程序执行于内核空间，与任何进程无关，故用户态进程程序切换到中断处理程序时，没有虚拟内存切换的成本，保持 TLB 不变即可。

### 上下文切换的时机



## 查看上下文切换